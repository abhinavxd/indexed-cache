/* indexed-cache - v0.4.4
* Kailash Nadh. Licensed MIT */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).IndexedCache=t()}(this,(function(){"use strict";function e(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function t(t){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?e(Object(n),!0).forEach((function(e){o(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):e(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function r(e,t,r,n,o,s,a){try{var i=e[s](a),c=i.value}catch(e){return void r(e)}i.done?t(c):Promise.resolve(c).then(n,o)}function n(e){return function(){var t=this,n=arguments;return new Promise((function(o,s){var a=e.apply(t,n);function i(e){r(a,o,s,i,c,"next",e)}function c(e){r(a,o,s,i,c,"throw",e)}i(void 0)}))}}function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}let s=!1;return class{constructor(e){if(s)throw new Error("indexed-cache is already loaded");s=!0,this.opt=t({tags:["script","img","link"],dbName:"indexed-cache",storeName:"objects",prune:!1,expiry:131400},e),this.db=null}init(){var e=this;return n((function*(){e.db||(yield e._initDB(e.opt.dbName,e.opt.storeName).then((t=>{e.db=t})).catch((e=>{console.log("error initializing cache DB. failing over.",e)})))}))()}load(e){var t=this;return n((function*(){const r=yield t._setupElements(e);if(t.db&&0!==r.length&&t.opt.prune){const e=r.map((e=>e.key));t._prune(e)}}))()}deleteKey(e){this.db&&this._store().delete(e)}prune(e){this._prune(e)}clear(){this.db&&this._store().clear()}_initDB(e,t){return new Promise(((r,n)=>{window.indexedDB||n(new Error("indexedDB is not available"));const o=window.indexedDB.open(e);o.onupgradeneeded=e=>{const n=e.target.result;e.target.result.objectStoreNames.contains(t)||(n.createObjectStore(t,{keyPath:"key"}),e.target.transaction.oncomplete=()=>{r(n)})},o.onsuccess=()=>r(o.result),o.onerror=e=>n(e.target.error),setTimeout((()=>{this.db||n(new Error("Opening IndexedbDB timed out"))}),200)}))}_setupElements(e){var r=this;return n((function*(){const n=[];if(e instanceof NodeList)e=Array.from(e);else if(e instanceof Node)e=[e];else{const t=r.opt.tags.map((e=>`${e}[data-src]:not([data-indexed])`)).join(",");e=document.querySelectorAll(t)}if(Array.prototype.forEach.call(e,(e=>{if("indexed"in e.dataset)return;const t={el:e,key:e.dataset.key||e.dataset.src,src:e.dataset.src,hash:e.dataset.hash||e.dataset.src,isAsync:"SCRIPT"!==e.tagName||e.hasAttribute("async")||e.hasAttribute("defer"),expiry:null,data:{}},o=e.dataset.expiry||r.opt.expiry;o&&(t.expiry=new Date((new Date).getTime()+6e4*parseInt(o))),n.push(t)})),!r.db)return void r._applyElements(n);const o=[];return n.forEach((e=>{e.isAsync?r._getObject(e).then((t=>{r._applyElement(e,t.data.blob)})).catch((t=>{r._applyElement(e)})):o.push(r._getObject(e))})),0===o.length||(yield function(e){const t=e.map((e=>Promise.resolve(e).then((e=>({status:"fulfilled",value:e})),(e=>({status:"rejected",reason:e})))));return Promise.all(t)}(o).then((e=>{const n=e.reduce(((e,r)=>(e.push(t(t({},r.value.obj),{},{data:r.value.data})),e)),[]);r._applyElements(n)}))),n}))()}_getObject(e){return new Promise(((t,r)=>{this._getDBblob(e).then((r=>{t({obj:e,data:r})})).catch((r=>{"Error"!==r.toString()&&console.log("error getting cache blob:",r),this._fetchObject(e).then((r=>{t({obj:e,data:r})})).catch((r=>{t({obj:e,data:{key:e.key,hash:e.hash,expiry:e.expiry,blob:null}})}))}))}))}_getDBblob(e){return new Promise(((t,r)=>{try{const n=this._store().get(e.key);n.onsuccess=n=>{const o=n.target.result;if(o&&(!e.hash||o.hash===e.hash))return o.expiry&&new Date>new Date(o.expiry)?(this.deleteKey(o.key),void r(new Error(""))):void t(o);r(new Error(""))},n.onerror=e=>{r(e.target.error)}}catch(e){r(e.target.error)}}))}_fetchObject(e){return new Promise(((t,r)=>{fetch(e.src).then((n=>{n.ok?n.blob().then((n=>{const o={key:e.key,hash:e.hash,expiry:e.expiry,blob:n};try{const e=this._store().put(o);e.onsuccess=()=>t(o),e.onerror=e=>r(e.target.error)}catch(e){r(e)}})):r(new Error(`error fetching asset: ${n.status}`))})).catch((e=>r(e)))}))}_applyElement(e,t){let r=e.src;switch(t&&(r=window.URL.createObjectURL(t)),e.el.tagName){case"SCRIPT":case"IMG":e.el.src=r;break;case"LINK":e.el.href=r}e.el.dataset.indexed=!0}_applyElements(e){e.forEach(((t,r)=>{r>=e.length-1||(t.el.onload=t.el.onerror=()=>{this._applyElement(e[r+1],e[r+1].data.blob)})})),this._applyElement(e[0],e[0].data.blob)}_prune(e){if(!this.db)return;const t=e.reduce(((e,t)=>(e[t]=!0,e)),{});this._store().getAllKeys().onsuccess=e=>{e.target.result.forEach((e=>{e in t||this.deleteKey(e)}))}}_store(){return this.db.transaction(this.opt.storeName,"readwrite").objectStore(this.opt.storeName)}}}));
