/* indexed-cache - v0.3.3
* Kailash Nadh. Licensed MIT */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).IndexedCache=t()}(this,(function(){"use strict";function e(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function t(e,t,r,n,o,a,s){try{var i=e[a](s),c=i.value}catch(e){return void r(e)}i.done?t(c):Promise.resolve(c).then(n,o)}function r(e){return function(){var r=this,n=arguments;return new Promise((function(o,a){var s=e.apply(r,n);function i(e){t(s,o,a,i,c,"next",e)}function c(e){t(s,o,a,i,c,"throw",e)}i(void 0)}))}}function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}let o=!1;return class{constructor(t){if(o)throw new Error("indexed-cache is already loaded");o=!0,this.opt=function(t){for(var r=1;r<arguments.length;r++){var o=null!=arguments[r]?arguments[r]:{};r%2?e(Object(o),!0).forEach((function(e){n(t,e,o[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):e(Object(o)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}))}return t}({tags:["script","img","link"],dbName:"indexed-cache",storeName:"objects",prune:!1,expiry:131400},t),this.db=null}init(){var e=this;return r((function*(){e.db||(yield e._initDB(e.opt.dbName,e.opt.storeName).then((t=>{e.db=t})).catch((e=>{console.log("error initializing cache DB. failing over.",e)})))}))()}load(e){var t=this;return r((function*(){let r=[];if(yield t._setupElements(e).then((e=>{r=e})),t.db&&0!==r.length&&t.opt.prune){const e=r.map((e=>e.key));t._prune(e)}}))()}deleteKey(e){this._store().delete(e)}prune(e){this._prune(e)}clear(){this._store().clear()}_initDB(e,t){return r((function*(){return new Promise(((r,n)=>{window.indexedDB||n(new Error("indexedDB is not available"));const o=window.indexedDB.open(e);o.onupgradeneeded=e=>{const n=e.target.result;e.target.result.objectStoreNames.contains(t)||(n.createObjectStore(t,{keyPath:"key"}),e.target.transaction.oncomplete=()=>{r(n)})},o.onsuccess=()=>r(o.result),o.onerror=e=>n(e.target.error)}))}))()}_setupElements(e){var t=this;return r((function*(){const r=[];if(e instanceof NodeList)e=Array.from(e);else if(e instanceof Node)e=[e];else{const r=t.opt.tags.map((e=>`${e}[data-src]:not([data-indexed])`)).join(",");e=document.querySelectorAll(r)}e.forEach((e=>{if("indexed"in e.dataset)return;const n={el:e,key:e.dataset.key||e.dataset.src,src:e.dataset.src,hash:e.dataset.hash||e.dataset.src,isAsync:"SCRIPT"!==e.tagName||e.hasAttribute("async")||e.hasAttribute("defer"),expiry:null},o=e.dataset.expiry||t.opt.expiry;o&&(n.expiry=new Date((new Date).getTime()+6e4*parseInt(o))),t.db?r.push(n):t._applyOriginal(n)}));const n=[];return r.forEach((e=>{e.isAsync?t._loadObject(e).then((r=>{t._applyBlob(e,r.data.blob)})).catch((r=>{t._applyOriginal(e)})):n.push(t._loadObject(e))})),0===n.length||(yield Promise.all(n).then((e=>{e.forEach(((r,n)=>{n>=e.length-1||(r.obj.el.onload=()=>{t._applyBlob(e[n+1].obj,e[n+1].data.blob)})})),t._applyBlob(e[0].obj,e[0].data.blob)}))),r}))()}_loadObject(e){var t=this;return r((function*(){return new Promise(((r,n)=>{t._getBlob(e).then((t=>{r({obj:e,data:t})})).catch((o=>{""===o.toString()&&console.log("error getting cache blob:",o),t._fetchAsset(e).then((t=>{r({obj:e,data:t})})).catch((e=>{n(new Error("error fetching asset: "+e))}))}))}))}))()}_getBlob(e){var t=this;return r((function*(){return new Promise(((r,n)=>{try{const o=t._store().get(e.key);o.onsuccess=o=>{const a=o.target.result;if(a&&(!e.hash||a.hash===e.hash))return a.expiry&&new Date>new Date(a.expiry)?(t.deleteKey(a.key),void n(new Error(""))):void r(a);n(new Error(""))},o.onerror=e=>{n(e.target.error)}}catch(e){n(e.target.error)}}))}))()}_fetchAsset(e){var t=this;return r((function*(){return new Promise(((r,n)=>{fetch(e.src).then((o=>{o.ok?o.blob().then((o=>{const a={key:e.key,hash:e.hash,expiry:e.expiry,blob:o};try{const e=t._store().put(a);e.onsuccess=e=>r(a),e.onerror=e=>n(e.target.error)}catch(e){n(e.target.error)}})):n(new Error(`error fetching asset: ${o.status}`))})).catch((e=>{n(new Error(e.toString()))}))}))}))()}_applyOriginal(e){switch(e.el.tagName){case"SCRIPT":case"IMG":e.el.setAttribute("src",e.src);break;case"LINK":e.el.setAttribute("href",e.src)}e.el.dataset.indexed=!0}_applyBlob(e,t){const r=window.URL.createObjectURL(t);switch(e.el.tagName){case"SCRIPT":case"IMG":e.el.src=r;break;case"LINK":e.el.href=r}e.el.dataset.indexed=!0}_prune(e){const t=e.reduce(((e,t)=>(e[t]=!0,e)),{});this._store().getAllKeys().onsuccess=e=>{e.target.result.forEach((e=>{e in t||this.deleteKey(e)}))}}_store(){return this.db.transaction(this.opt.storeName,"readwrite").objectStore(this.opt.storeName)}}}));
