/* indexed-cache - v0.2.1
* Kailash Nadh. Licensed MIT */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).IndexedCache=t()}(this,(function(){"use strict";function e(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function t(e,t,r,n,o,a,s){try{var c=e[a](s),i=c.value}catch(e){return void r(e)}c.done?t(i):Promise.resolve(i).then(n,o)}function r(e){return function(){var r=this,n=arguments;return new Promise((function(o,a){var s=e.apply(r,n);function c(e){t(s,o,a,c,i,"next",e)}function i(e){t(s,o,a,c,i,"throw",e)}c(void 0)}))}}function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}let o=!1;return class{constructor(t){if(o)throw new Error("indexed-cache is already loaded");o=!0,this.opt=function(t){for(var r=1;r<arguments.length;r++){var o=null!=arguments[r]?arguments[r]:{};r%2?e(Object(o),!0).forEach((function(e){n(t,e,o[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):e(Object(o)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}))}return t}({tags:["script","img","link"],dbName:"indexed-cache",storeName:"objects",prune:!1,expiry:131400},t),this.db=null}load(){var e=this;return r((function*(){yield e._initDB(e.opt.dbName,e.opt.storeName).then((t=>{e.db=t})).catch((e=>{console.log("error initializing cache DB. failing over.",e)}));let t=[];yield e._setupElements().then((e=>{t=e})),e.db&&e.opt.prune&&e._prune(t)}))()}deleteKey(e){this._store().delete(e)}clear(){this._store().clear()}_initDB(e,t){return r((function*(){return new Promise(((r,n)=>{window.indexedDB||n(new Error("indexedDB is not available"));const o=window.indexedDB.open(e);o.onupgradeneeded=e=>{const n=e.target.result;e.target.result.objectStoreNames.contains(t)||(n.createObjectStore(t,{keyPath:"key"}),e.target.transaction.oncomplete=()=>{r(n)})},o.onsuccess=()=>r(o.result),o.onerror=e=>n(e.target.error)}))}))()}_setupElements(){var e=this;return r((function*(){const t=[];e.opt.tags.forEach((r=>{document.querySelectorAll(`${r}[data-src]`).forEach((r=>{const n={el:r,key:r.dataset.key||r.dataset.src,src:r.dataset.src,hash:r.dataset.hash||r.dataset.src,isAsync:"SCRIPT"!==r.tagName||r.hasAttribute("async")||r.hasAttribute("defer"),expiry:null},o=r.dataset.expiry||e.opt.expiry;o&&(n.expiry=new Date((new Date).getTime()+6e4*parseInt(o))),e.db?t.push(n):e._applyOriginal(n)}))}));const r=[];return t.forEach((t=>{t.isAsync?e._loadObject(t).then((r=>{e._applyBlob(t,r.data.blob)})).catch((r=>{e._applyOriginal(t)})):r.push(e._loadObject(t))})),yield Promise.all(r).then((t=>{t.forEach(((r,n)=>{n>=t.length-1||(r.obj.el.onload=()=>{e._applyBlob(t[n+1].obj,t[n+1].data.blob)})})),e._applyBlob(t[0].obj,t[0].data.blob)})),t}))()}_loadObject(e){var t=this;return r((function*(){return new Promise(((r,n)=>{t._getBlob(e).then((t=>{r({obj:e,data:t})})).catch((o=>{o&&console.log("error getting cache blob:",o),t._fetchAsset(e).then((t=>{r({obj:e,data:t})})).catch((e=>{n(new Error("error fetching asset: "+e))}))}))}))}))()}_getBlob(e){var t=this;return r((function*(){return new Promise(((r,n)=>{const o=t._store().get(e.key);o.onsuccess=o=>{const a=o.target.result;if(a&&(!e.hash||a.hash===e.hash))return a.expiry&&new Date>new Date(a.expiry)?(t.deleteKey(a.key),void n(new Error(null))):void r(a);n(new Error(null))},o.onerror=e=>{n(e.target.error)}}))}))()}_fetchAsset(e){var t=this;return r((function*(){return new Promise(((r,n)=>{fetch(e.src).then((o=>{o.ok?o.blob().then((o=>{const a={key:e.key,hash:e.hash,expiry:e.expiry,blob:o},s=t._store().put(a);s.onsuccess=e=>r(a),s.onerror=e=>n(e.target.error)})):n(new Error(`error fetching asset: ${o.status}`))})).catch((e=>{n(e.target.error)}))}))}))()}_applyOriginal(e){switch(e.el.tagName){case"SCRIPT":case"IMG":e.el.setAttribute("src",e.src);break;case"LINK":e.el.setAttribute("href",e.src)}}_applyBlob(e,t){const r=window.URL.createObjectURL(t);switch(e.el.tagName){case"SCRIPT":case"IMG":e.el.src=r;break;case"LINK":e.el.href=r}}_prune(e){const t=e.reduce(((e,t)=>(e[t.key]=!0,e)),{});this._store().getAllKeys().onsuccess=e=>{e.target.result.forEach((e=>{e in t||this.deleteKey(e)}))}}_store(){return this.db.transaction(this.opt.storeName,"readwrite").objectStore(this.opt.storeName)}}}));
